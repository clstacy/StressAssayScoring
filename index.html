<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stress Assay Scoring App</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #container {
      display: flex;
    }

    #sidebar {
      width: 300px;
      padding: 20px;
      box-sizing: border-box;
      background-color: #f9f9f9;
      overflow-y: auto;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
    }

    #mainContent {
      margin-left: 300px;
      padding: 20px;
      overflow-y: auto;
      height: 100vh;
      box-sizing: border-box;
    }

    #imageGrid {
      display: flex;
      flex-wrap: wrap;
    }

    .imageItem {
      position: relative;
      margin: 5px;
    }

    .imageItem img {
      width: 150px;
      height: auto;
      border: 3px solid black;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .imageItem .scoreOverlay {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 2px 5px;
      font-size: 14px;
      z-index: 10;
    }

    #paginationControls {
      margin-top: 10px;
      text-align: center;
    }

    #paginationControls button {
      margin: 0 5px;
    }

    #loadingMessage {
      font-size: 18px;
      color: green;
    }

    #progressBar {
      width: 100%;
      background-color: #ddd;
      display: none;
    }

    #progressBar div {
      width: 0%;
      height: 20px;
      background-color: #4caf50;
      text-align: center;
      line-height: 20px;
      color: white;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <h1>Stress Assay Scoring App</h1>

      <div id="instructions">
        <h2>Instructions</h2>
        <ol>
          <li>Upload a folder containing your images.</li>
          <li>Set custom scores if desired, or use default scores by clicking "Set Scores" without entering any scores.</li>
          <li>Set the replication factor (e.g., 1.5 for 50% additional replicates).</li>
          <li>Click "Load Images" to begin.</li>
          <li>Select a score and click on images to assign or change scores.</li>
          <li>Use pagination controls to navigate through images.</li>
          <li>Once finished, click "Download Scores" to export the data.</li>
        </ol>
      </div>

      <label for="fileInput">Upload Images (Folder or Files):</label>
      <input type="file" id="fileInput" accept=".jpg,.jpeg,.png" webkitdirectory multiple>
      <br><br>

      <label for="scorerName">Scorer Name:</label>
      <input type="text" id="scorerName" placeholder="Enter scorer's name">
      <br><br>

      <label for="customScores">Enter Custom Scores (comma-separated, optionally with labels using colon):</label>
      <input type="text" id="customScores" placeholder="e.g., 0: Poor,1: Fair,2: Good">
      <button id="setScores">Set Scores</button>
      <br><br>

      <label for="replicationFactor">Replication Factor (e.g., 1.5):</label>
      <input type="number" id="replicationFactor" value="1" min="1" step="0.1">
      <br><br>

      <button id="loadImages">Load Images</button>
      <br><br>

      <label for="scoreSelector">Select Score:</label>
      <select id="scoreSelector"></select>
      <button id="downloadScores">Download Scores</button>
      <br><br>

      <div id="loadingMessage"></div>
      <div id="progressBar"><div></div></div>
    </div>

    <div id="mainContent">
      <div id="paginationControls" style="display: none;">
        <button id="prevPage">Previous</button>
        <span id="pageInfo"></span>
        <button id="nextPage">Next</button>
      </div>
      <hr>
      <div id="imageGrid"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    let images = [];
    let scores = {};
    let scoreLabels = {};
    let currentPage = 1;
    let totalPages = 1;
    let scoreColors = {};
    let replicationFactor = 1;

    document.addEventListener('DOMContentLoaded', () => {
      setDefaultScores();
    });

    function setDefaultScores() {
      const defaultScoresArray = ['0', '1', '2', '3', '4'];
      scoreLabels = {
        '0': '0 (0-2 colonies)',         
        '1': '1 (3-10 colonies)',         
        '2': '2 (>11, countable)',         
        '3': '3 (TNTC, no Confluence)',         
        '4': '4 (TNTC, Confluent)'
      };
      assignScoreColors(defaultScoresArray);
      populateScoreSelector(defaultScoresArray);
    }

    document.getElementById('fileInput').addEventListener('change', function(event) {
      const files = event.target.files;
      if (files.length > 0) {
        document.getElementById('loadingMessage').textContent = 'Ready to load images.';
      }
    });

    document.getElementById('setScores').addEventListener('click', () => {
      const customScoresInput = document.getElementById('customScores').value.trim();
      if (customScoresInput === '') {
        setDefaultScores();
      } else {
        const customScoresArray = parseCustomScores(customScoresInput);
        if (customScoresArray.length === 0) {
          alert('Please enter valid scores.');
          return;
        }
        assignScoreColors(customScoresArray);
        populateScoreSelector(customScoresArray);
      }
    });

    document.getElementById('loadImages').addEventListener('click', async () => {
      const fileInput = document.getElementById('fileInput');
      const files = fileInput.files;
      const scorerName = document.getElementById('scorerName').value;
      if (!scorerName) {
        alert('Please enter the scorer\'s name.');
        return;
      }
      if (files.length === 0) {
        alert('Please upload images.');
        return;
      }

      document.getElementById('loadingMessage').textContent = 'Loading and processing images...';
      document.getElementById('progressBar').style.display = 'block';

      images = [];
      scores = {};
      const validExtensions = ['jpg', 'jpeg', 'png'];
      const totalFiles = files.length;
      let processedFiles = 0;

      for (const file of files) {
        const fileExtension = file.name.split('.').pop().toLowerCase();
        if (!validExtensions.includes(fileExtension)) {
          console.warn(`${file.name} is not a supported image file.`);
          updateProgress(++processedFiles, totalFiles);
          continue;
        }

        try {
          const imgData = await readFileAsync(file);
          images.push({
            name: file.name,
            data: imgData,
            isReplicate: false,
            originalName: file.name,
            rotation: getRandomRotation()
          });
        } catch (error) {
          console.error(`Error loading image ${file.name}:`, error);
        }

        updateProgress(++processedFiles, totalFiles);
      }

      if (images.length === 0) {
        alert('No valid images found.');
        document.getElementById('loadingMessage').textContent = '';
        document.getElementById('progressBar').style.display = 'none';
        return;
      }

      replicationFactor = parseFloat(document.getElementById('replicationFactor').value) || 1;
      images = replicateImages(images, replicationFactor);

      shuffleArray(images);

      currentPage = 1;
      totalPages = Math.ceil(replicationFactor);

      sortImages();
      displayImages();

      document.getElementById('loadingMessage').textContent = '';
      document.getElementById('progressBar').style.display = 'none';
    });

    function updateProgress(processed, total) {
      const progressBar = document.getElementById('progressBar').children[0];
      const percentage = Math.round((processed / total) * 100);
      progressBar.style.width = percentage + '%';
      progressBar.textContent = percentage + '%';
    }

    function readFileAsync(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(event) {
          resolve(event.target.result);
        };
        reader.onerror = function(error) {
          reject(error);
        };
        reader.readAsDataURL(file);
      });
    }

    function parseCustomScores(input) {
      const scores = input.split(',').map(s => s.trim()).filter(s => s !== '');
      const uniqueScores = [];
      scoreLabels = {};

      scores.forEach(s => {
        const [score, label] = s.split(':').map(part => part.trim());
        if (score && !uniqueScores.includes(score)) {
          uniqueScores.push(score);
          scoreLabels[score] = label || score;
        }
      });

      return uniqueScores;
    }

    function assignScoreColors(scoresArray) {
      const colors = ['red', 'blue', 'green', 'orange', 'purple', 'brown', 'pink', 'gray', 'teal', 'magenta'];
      scoreColors = {};
      scoresArray.forEach((score, index) => {
        scoreColors[score] = colors[index % colors.length];
      });
    }

    function populateScoreSelector(scoresArray) {
      const scoreSelector = document.getElementById('scoreSelector');
      scoreSelector.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '-- Select Score --';
      scoreSelector.appendChild(defaultOption);

      scoresArray.forEach(score => {
        const option = document.createElement('option');
        option.value = score;
        option.textContent = scoreLabels[score] || score;
        scoreSelector.appendChild(option);
      });
    }

    function replicateImages(imagesArray, replicationFactor) {
      const replicatedImages = [];
      const totalReps = Math.floor(replicationFactor);
      const extraRepFraction = replicationFactor - totalReps;

      // Replicate images for the integer part of replication factor
      for (let i = 1; i <= totalReps; i++) {
        imagesArray.forEach(image => {
          const replicatedImage = {
            ...image,
            isReplicate: i > 1,
            name: i === 1 ? image.originalName : `${image.originalName}_replicate_${i - 1}`,
            rotation: getRandomRotation(),
            replicateNumber: i
          };
          replicatedImages.push(replicatedImage);
        });
      }

      // Handle fractional replication
      if (extraRepFraction > 0) {
        const additionalReps = [];
        const numExtraReps = Math.round(imagesArray.length * extraRepFraction);
        const shuffledImages = [...imagesArray];
        shuffleArray(shuffledImages);
        const selectedImages = shuffledImages.slice(0, numExtraReps);

        selectedImages.forEach(image => {
          const replicatedImage = {
            ...image,
            isReplicate: true,
            name: `${image.originalName}_replicate_${totalReps}`,
            rotation: getRandomRotation(),
            replicateNumber: totalReps + 1
          };
          replicatedImages.push(replicatedImage);
        });

        totalPages += 1;
      }

      return replicatedImages;
    }

    function getRandomRotation() {
      return Math.random() < 0.5 ? 0 : 180;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function sortImages() {
      images.sort((a, b) => {
        const aScored = scores[a.name] ? 1 : 0;
        const bScored = scores[b.name] ? 1 : 0;

        if (aScored !== bScored) {
          return aScored - bScored; // Unscored images first
        } else {
          return 0; // Keep current order
        }
      });
    }

    function displayImages() {
      const grid = document.getElementById('imageGrid');
      grid.innerHTML = '';

      const imagesToDisplay = images.filter(img => img.replicateNumber === currentPage);

      imagesToDisplay.forEach((img, index) => {
        const imgContainer = document.createElement('div');
        imgContainer.classList.add('imageItem');

        const imgElement = document.createElement('img');
        imgElement.src = img.data;
        imgElement.dataset.index = index;
        imgElement.style.transform = `rotate(${img.rotation}deg)`;
        imgElement.addEventListener('click', () => {
          const scoreSelector = document.getElementById('scoreSelector');
          if (scoreSelector.value === '') {
            alert('Please select a score.');
            return;
          }
          const score = scoreSelector.value;
          const scoreText = scoreLabels[score];
          const timestamp = new Date().toISOString();
          scores[img.name] = {
            score: score,
            scoreDescription: scoreText,
            timestamp: timestamp,
            isReplicate: img.isReplicate || false,
            originalName: img.originalName
          };
          imgElement.style.borderColor = scoreColors[score] || 'red';

          if (!imgContainer.querySelector('.scoreOverlay')) {
            const overlay = document.createElement('div');
            overlay.classList.add('scoreOverlay');
            overlay.textContent = 'Score: ' + scoreText;
            imgContainer.appendChild(overlay);
          } else {
            imgContainer.querySelector('.scoreOverlay').textContent = 'Score: ' + scoreText;
          }

          sortImages();
          displayImages();
        });

        if (scores[img.name]) {
          const assignedScore = scores[img.name].score;
          imgElement.style.borderColor = scoreColors[assignedScore] || 'red';
          const overlay = document.createElement('div');
          overlay.classList.add('scoreOverlay');
          overlay.textContent = 'Score: ' + scoreLabels[assignedScore];
          imgContainer.appendChild(overlay);
        }

        imgContainer.appendChild(imgElement);
        grid.appendChild(imgContainer);
      });

      updatePaginationControls();
    }

    function updatePaginationControls() {
      const paginationControls = document.getElementById('paginationControls');
      paginationControls.style.display = 'block';
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        sortImages();
        displayImages();
      }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        sortImages();
        displayImages();
      }
    });

    function getScoreLabel(score) {
      return scoreLabels[score] || score;
    }

    document.getElementById('downloadScores').addEventListener('click', () => {
      const scorerName = document.getElementById('scorerName').value;

      const unscoredImages = images.filter(img => !scores[img.name]);
      if (unscoredImages.length > 0) {
        const proceed = confirm(`There are ${unscoredImages.length} unscored images. Do you want to proceed?`);
        if (!proceed) return;
      }

      const unscoredReplicates = images.filter(img => img.isReplicate && !scores[img.name]);
      if (unscoredReplicates.length > 0) {
        alert(`Warning: Not all replicates have been scored.`);
      }

      const inconsistencies = checkConsistency();

      if (inconsistencies.length > 0) {
        alert(`There are ${inconsistencies.length} inconsistencies in replicated scores.`);
      }

      let csvContent = "Scorer Name,File Name,Numeric Score,Score Description,Timestamp,Replicate #,Original File Name\n";
      images.sort((a, b) => a.originalName.localeCompare(b.originalName));
      images.forEach(img => {
        const data = scores[img.name];
        const numericScore = data ? data.score : '';
        const scoreDescription = data ? data.scoreDescription : '';
        const timestamp = data ? data.timestamp : '';
        const replicateNum = img.replicateNumber;
        const originalFileName = img.originalName;
        csvContent += `"${scorerName}","${img.name}","${numericScore}","${scoreDescription}","${timestamp}","${replicateNum}","${originalFileName}"\n`;
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, 'image_scores.csv');
    });

    function checkConsistency() {
      const inconsistencies = [];
      const scoreMap = {};

      images.forEach(img => {
        if (!scores[img.name]) return;
        const key = img.originalName;
        if (!scoreMap[key]) {
          scoreMap[key] = scores[img.name].score;
        } else {
          if (scoreMap[key] !== scores[img.name].score) {
            inconsistencies.push({
              originalFileName: img.originalName,
              replicateFileName: img.name,
              originalScore: getScoreLabel(scoreMap[key]),
              replicateScore: getScoreLabel(scores[img.name].score)
            });
          }
        }
      });
      return inconsistencies;
    }
  </script>
</body>
</html>
